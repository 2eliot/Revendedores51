<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Pines</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
</head>
<body>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages-main">
        {% for category, message in messages %}
          <div class="flash-message-main flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <header class="admin-header">
    <div class="admin-title">
      <h1>üìå Pines de Free Fire</h1>
    </div>
    <div class="admin-info">
      <a href="/admin" class="btn" style="background:#007bff;color:#fff;padding:8px 16px;text-decoration:none;border-radius:4px;margin-right:10px;">üè† Volver al Panel</a>
      <a href="/logout" class="logout-btn">Cerrar Sesi√≥n</a>
    </div>
  </header>

  <main class="admin-main">
    <section class="pins-section">
      <div class="filters" style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
        <form method="GET" action="/admin/pins" style="display:flex;gap:8px;align-items:center;">
          <label>Juego:</label>
          <select name="game">
            <option value="freefire_latam" {% if game=='freefire_latam' %}selected{% endif %}>Free Fire Latam</option>
            <option value="freefire_global" {% if game=='freefire_global' %}selected{% endif %}>Free Fire</option>
          </select>
          <label>Estado:</label>
          <select name="estado">
            <option value="unused" {% if only_unused %}selected{% endif %}>Sin usar</option>
            <option value="all" {% if not only_unused %}selected{% endif %}>Todos</option>
          </select>
          <button type="submit" class="btn btn-primary">Filtrar</button>
        </form>
      </div>

      <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap;">
        <form method="POST" action="/admin/delete_pins_batch" onsubmit="return confirm('¬øEliminar el lote seleccionado? Esta acci√≥n no se puede deshacer.');" style="display:flex; gap:8px; align-items:center;">
          <input type="hidden" name="game" value="{{ game }}">
          <input type="hidden" name="estado" value="{% if only_unused %}unused{% else %}all{% endif %}">
          <select name="batch_id" required>
            <option value="" disabled selected>Selecciona un lote‚Ä¶</option>
            {% for grp in pin_groups %}
              {% if grp.batch_id %}
                <option value="{{ grp.batch_id }}">{{ grp.fecha_agregado }} | {{ grp.paquete }} | {{ grp.pins|length }} pines | {{ grp.batch_id }}</option>
              {% endif %}
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-danger">üóëÔ∏è Eliminar lote</button>
        </form>
        <a class="btn" href="/admin/pins?game={{ game }}&estado={% if only_unused %}unused{% else %}all{% endif %}{% if monto %}&monto={{ monto }}{% endif %}">‚Üª Actualizar</a>
      </div>

      <form method="POST" action="/admin/delete_pins" onsubmit="return confirm('¬øEliminar los pines seleccionados? Esta acci√≥n no se puede deshacer.');">
        <input type="hidden" name="game" value="{{ game }}">
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="select-all" /></th>
                <th>ID</th>
                <th>Paquete</th>
                <th>Monto ID</th>
                <th>Pin</th>
                <th>Usado</th>
                <th>Fecha agregado</th>
                <th>Lote</th>
              </tr>
            </thead>
            <tbody>
              {% for grp in pin_groups %}
                <tr>
                  <td colspan="8" style="background:#f6f7f9;font-weight:600;">
                    {{ grp.fecha_agregado }}
                    {% if grp.batch_id %}
                      | Lote: <code>{{ grp.batch_id }}</code>
                      | Cantidad: {{ grp.pins|length }}
                    {% else %}
                      | Pin individual
                    {% endif %}
                    | {{ grp.paquete }}
                  </td>
                </tr>
                {% for pin in grp.pins %}
                <tr>
                  <td><input type="checkbox" name="pin_ids" value="{{ pin.id }}" class="row-check" /></td>
                  <td>{{ pin.id }}</td>
                  <td>{{ pin.paquete }}</td>
                  <td>{{ pin.monto_id }}</td>
                  <td><code>{{ pin.pin_codigo }}</code></td>
                  <td>{% if pin.usado %}S√≠{% else %}No{% endif %}</td>
                  <td>{{ pin.fecha_agregado }}</td>
                  <td>{% if pin.batch_id %}<code>{{ pin.batch_id }}</code>{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
              {% endfor %}
              {% if pin_groups is not defined or pin_groups|length == 0 %}
              <tr>
                <td colspan="8" style="text-align:center;">No hay pines para mostrar</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button type="submit" class="btn btn-danger">üóëÔ∏è Eliminar seleccionados</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    // Auto-ocultar mensajes flash
    setTimeout(function() {
      const flashMessages = document.querySelector('.flash-messages-main');
      if (flashMessages) {
        flashMessages.style.opacity = '0';
        setTimeout(() => flashMessages.remove(), 300);
      }
    }, 2000);

    // Seleccionar/Deseleccionar todos
    const selectAll = document.getElementById('select-all');
    if (selectAll) {
      selectAll.addEventListener('change', function() {
        document.querySelectorAll('.row-check').forEach(cb => cb.checked = selectAll.checked);
      });
    }
  </script>
</body>
</html>
